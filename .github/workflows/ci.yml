name: build-and-test

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    CTEST_OUTPUT_ON_FAILURE: 1

jobs:
    build-ubuntu:
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-24.04]
                build_type: [Release, Debug]
                compiler: [{ "cc": "gcc", "cxx": "g++" }]
        env:
            CC: ${{ matrix.compiler.cc }}
            CXX: ${{ matrix.compiler.cxx }}
        steps:
            - name: checkout
              uses: actions/checkout@v5.0.0
              with:
                  # get all the branches and tags
                  fetch-depth: 0
                  persist-credentials: false
            - name: setup
              run: |
                  sudo apt update
                  sudo apt install -y libeigen3-dev
                  mkdir ${{ runner.temp }}/build
            - name: build
              working-directory: ${{ runner.temp }}/build
              run: |
                  cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DBUILD_TESTING=ON
                  make -j4
            - name: test
              working-directory: ${{ runner.temp }}/build
              run: |
                  make test

    fix-cpp-lint:
        runs-on: ubuntu-22.04

        permissions:
            contents: read
            statuses: write

        steps:
            - name: checkout code
              uses: actions/checkout@v5.0.0
              with:
                  # get all the branches and tags
                  fetch-depth: 0
                  persist-credentials: false

            # we gotta fix linting within C++, JSON and CMakeLists
            - name: run super-linter
              uses: super-linter/super-linter@v8.2.0
              env:
                  VALIDATE_CLANG_FORMAT: True
                  VALIDATE_JSON: True
                  IGNORE_GITIGNORED_FILES: True
                  CLANG_FORMAT_FILE_NAME: .clang-format
                  FILTER_REGEX_INCLUDE: (.*config/.*|.*include/aw_logger/.*|.*src/.*)
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name:
                  Commit and push linting fixes
                  # Run only on:
                  # - Pull requests
                  # - Not on the default branch
              if: >
                  github.event_name == 'pull_request' &&
                  github.ref_name != github.event.repository.default_branch
              uses: stefanzweifel/git-auto-commit-action@v7
              with:
                  branch: ${{ github.event.pull_request.head.ref || github.head_ref || github.ref }}
                  commit_message: "super-linter: fix linting issues"
                  commit_user_name: super-linter
                  commit_user_email: super-linter@super-linter.dev

            - run: echo "🎉 Linting issues fixed!"
